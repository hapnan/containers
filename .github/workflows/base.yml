name: Docker Image Build and Release

on:
  push:
    paths:
      - ".github/workflows/base.yml"
      - "official-templates/base/docker-bake.hcl"
      - "official-templates/base/Dockerfile"
      - "official-templates/pytorch/docker-bake.hcl"
      - "official-templates/pytorch/Dockerfile"
      - "official-templates/shared/**"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-base:
    runs-on: runs-on=${{ github.run_id }}/runner=8cpu-linux-x64/image=ubuntu22-full-x64/volume=500gb:gp3:500mbs:4000iops
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker system prune -af
          sudo apt-get clean
          df -h
      
      - name: Setup Docker
        uses: ./.github/actions/docker-setup
        id: setup
        with:
          dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build base images
        uses: docker/bake-action@v6
        env:
          BUILDX_BAKE_ENTITLEMENTS_FS: 0
          RELEASE_SUFFIX: ${{ steps.setup.outputs.release-suffix }}
          RP_SKIP_PYTHON: ""           # Leave empty to install Python
          RP_SKIP_JUPYTER: ""          # Leave empty to install Jupyter
        with:
          source: .
          files: |
            official-templates/shared/versions.hcl
            official-templates/base/docker-bake.hcl
          push: true

  build-pytorch:
    needs: build-base
    # always() forces job run even if the dependant is skipped (but not if it failed)
    if: always() && (needs.build-base.result == 'success' || needs.build-base.result == 'skipped')
    runs-on: runs-on=${{ github.run_id }}/runner=16cpu-linux-x64/image=ubuntu24-full-x64/volume=500gb:gp3:500mbs:4000iops
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Check if build is needed
        uses: tj-actions/changed-files@v47
        id: changes
        with:
          files_yaml: |
            pytorch:
              - 'official-templates/shared/**'
              - 'official-templates/pytorch/**'

      - name: Free up disk space
        if: github.event_name == 'workflow_dispatch' || steps.changes.outputs.pytorch_any_changed == 'true'
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker system prune -af
          sudo apt-get clean
          df -h

      - name: Setup Docker
        if: github.event_name == 'workflow_dispatch' || steps.changes.outputs.pytorch_any_changed == 'true'
        uses: ./.github/actions/docker-setup
        id: setup
        with:
          dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
          dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build pytorch images
        if: github.event_name == 'workflow_dispatch' || steps.changes.outputs.pytorch_any_changed == 'true'
        uses: docker/bake-action@v6
        env:
          BUILDX_BAKE_ENTITLEMENTS_FS: 0
          RELEASE_SUFFIX: ${{ steps.setup.outputs.release-suffix }}
        with:
          source: .
          files: |
            official-templates/shared/versions.hcl
            official-templates/pytorch/docker-bake.hcl
          push: true
